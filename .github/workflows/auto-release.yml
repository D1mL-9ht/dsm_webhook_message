# å·¥ä½œæµåç§°ï¼šæ¨Tagè‡ªåŠ¨æ‰“åŒ…å¹¶å‘å¸ƒRelease
name: Auto Build & Release

# è§¦å‘æ¡ä»¶ï¼šæ¨æ‰€æœ‰vå¼€å¤´çš„Tagï¼ˆå¦‚v1.0.0ã€v1.1.0ã€v1.0.1ï¼‰æ—¶è§¦å‘
on:
  push:
    tags:
      - 'v*'

# å·¥ä½œæµä»»åŠ¡
jobs:
  build-and-release:
    # è¿è¡Œåœ¨Ubuntu 22.04äº‘ç«¯ç¯å¢ƒï¼ˆå’Œä½ Docker/Linuxæ‰“åŒ…ç¯å¢ƒä¸€è‡´ï¼Œé¿å…äºŒè¿›åˆ¶å…¼å®¹é—®é¢˜ï¼‰
    runs-on: ubuntu-22.04
    steps:
      # æ­¥éª¤1ï¼šæ‹‰å–GitHubä»“åº“çš„ä»£ç åˆ°äº‘ç«¯ç¯å¢ƒ
      - name: Checkout code
        uses: actions/checkout@v4

      # æ­¥éª¤2ï¼šé…ç½®Pythonç¯å¢ƒï¼ˆå’Œä½ æœ¬åœ°çš„Python3ç‰ˆæœ¬ä¸€è‡´ï¼Œé€‰3.11å…¼å®¹Nuitkaï¼‰
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip' # ç¼“å­˜pipä¾èµ–ï¼ŒåŠ å¿«åç»­æ„å»º

      # æ­¥éª¤3ï¼šå®‰è£…ä¾èµ–ï¼ˆpipå®‰è£…Nuitkaå’Œä½ é¡¹ç›®çš„æ‰€æœ‰ä¾èµ–ï¼‰
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install nuitka # å®‰è£…æ‰“åŒ…å·¥å…·Nuitka
          # ğŸ‘‡ å…³é”®ï¼šå¦‚æœä½ çš„é¡¹ç›®æœ‰å…¶ä»–ä¾èµ–ï¼ˆå¦‚requestsã€pytestï¼‰ï¼ŒæŠŠå®ƒä»¬å†™åœ¨è¿™é‡Œï¼Œç”¨ç©ºæ ¼åˆ†éš”
          pip install requests flask

      # æ­¥éª¤4ï¼šæ‰§è¡ŒNuitkaæ‰“åŒ…ï¼ˆå’Œä½ æœ¬åœ°çš„æ‰“åŒ…å‘½ä»¤å®Œå…¨ä¸€è‡´ï¼Œç”Ÿæˆrelease/dsm_webhook_messageï¼‰
      - name: Build with Nuitka
        run: |
          python -m nuitka --onefile --output-filename=dsm_webhook_message --output-dir=./release --remove-output --lto=full --static-libpython=yes main.py

      # æ­¥éª¤5ï¼šåˆ›å»ºGitHub Releaseå¹¶ä¸Šä¼ æ‰“åŒ…çš„äºŒè¿›åˆ¶æ–‡ä»¶
      - name: Create Release & Upload Asset
        uses: softprops/action-gh-release@v2
        with:
          # Releaseæ ‡é¢˜ï¼šå’ŒTagä¸€è‡´ï¼ˆå¦‚v1.0.1ï¼‰
          name: ${{ github.ref_name }}
          # Releaseæè¿°ï¼šå¯æ‰‹åŠ¨åœ¨GitHubç¼–è¾‘ï¼Œè¿™é‡Œé»˜è®¤å–Tagçš„å¤‡æ³¨
          body: "è‡ªåŠ¨æ„å»ºå‘å¸ƒï¼š${{ github.ref_name }} ç‰ˆæœ¬ï¼ŒåŒ…å«Linux/amd64æ¶æ„äºŒè¿›åˆ¶æ–‡ä»¶"
          # ä¸Šä¼ çš„æ–‡ä»¶è·¯å¾„ï¼šæŒ‡å‘Nuitkaæ‰“åŒ…çš„äºŒè¿›åˆ¶
          files: ./release/dsm_webhook_message
        # å¿…é¡»çš„ä»¤ç‰Œï¼šGitHubè‡ªåŠ¨ç”Ÿæˆï¼Œæ— éœ€æ‰‹åŠ¨é…ç½®ï¼Œç”¨äºæˆæƒåˆ›å»ºRelease
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}