# å·¥ä½œæµåç§°ï¼šæ¨Tagè‡ªåŠ¨æ‰“åŒ…å¹¶å‘å¸ƒRelease
name: Auto Build & Release

# è§¦å‘æ¡ä»¶ï¼šæ¨æ‰€æœ‰vå¼€å¤´çš„Tag
on:
  push:
    tags:
      - 'v*'

# å·¥ä½œæµä»»åŠ¡
jobs:
  build-and-release:
    # æ ¸å¿ƒä¿®æ”¹ï¼šæ›¿æ¢ä¸ºDebian 12äº‘ç«¯ç¯å¢ƒ
    runs-on: debian-12
    steps:
      # æ­¥éª¤1ï¼šæ‹‰å–GitHubä»“åº“çš„ä»£ç åˆ°äº‘ç«¯ç¯å¢ƒï¼ˆæ·±åº¦1æ‹‰å–å…¨é‡ä»£ç ï¼Œé¿å…æ‰“åŒ…ç¼ºå¤±æ–‡ä»¶ï¼‰
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # æ­¥éª¤2ï¼šé…ç½®Pythonç¯å¢ƒï¼ˆ3.11å…¼å®¹Nuitkaï¼Œç¼“å­˜pipä¾èµ–åŠ å¿«æ„å»ºï¼ŒDebianä¸‹æ— å·®å¼‚ï¼‰
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      # æ­¥éª¤3ï¼šå®‰è£…ä¾èµ–ï¼ˆNuitka+é¡¹ç›®ä¸šåŠ¡ä¾èµ–ï¼ŒDebianä¸‹pipå‘½ä»¤å’ŒUbuntuå®Œå…¨ä¸€è‡´ï¼‰
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          # å®‰è£…æ‰“åŒ…å·¥å…·å’Œé¡¹ç›®ä¾èµ–ï¼ŒæŒ‰éœ€è¡¥å……
          pip install nuitka requests flask
          # éªŒè¯å®‰è£…ï¼ˆå¯é€‰ï¼Œæ–¹ä¾¿æ’æŸ¥ä¾èµ–é—®é¢˜ï¼‰
          pip list | grep -E 'nuitka|requests|flask'

      # æ­¥éª¤4ï¼šåˆ›å»ºreleaseç›®å½•+Nuitkaæ‰“åŒ…
      - name: Build with Nuitka
        run: |
          # å¼ºåˆ¶åˆ›å»ºreleaseç›®å½•ï¼Œé¿å…ç›®å½•ä¸å­˜åœ¨å¯¼è‡´æ‰“åŒ…å¤±è´¥
          mkdir -p ./release
          # åŸæ‰“åŒ…å‘½ä»¤ï¼ˆä¿ç•™Tag+æ¶æ„åç¼€ï¼Œç”Ÿæˆå”¯ä¸€æ–‡ä»¶åï¼ŒDebianä¸‹Nuitkaæ‰“åŒ…æ— å…¼å®¹é—®é¢˜ï¼‰
          python -m nuitka --onefile \
            --output-filename=dsm_webhook_message_${{ github.ref_name }}_linux_amd64 \
            --output-dir=./release \
            --remove-output \
            --lto=yes \
            --static-libpython=yes \
            app.py
          # å…³é”®ï¼šæ‰“å°releaseç›®å½•æ–‡ä»¶ï¼Œç¡®è®¤æ‰“åŒ…äº§ç‰©ç”ŸæˆæˆåŠŸï¼ˆæ–¹ä¾¿æ’æŸ¥ï¼‰
          echo "===== æ‰“åŒ…äº§ç‰©åˆ—è¡¨ ====="
          ls -l ./release/
          echo "========================"

      # æ­¥éª¤5ï¼šåˆ›å»ºGitHub Releaseå¹¶ä¸Šä¼ äºŒè¿›åˆ¶æ–‡ä»¶
      - name: Create Release & Upload Asset
        uses: softprops/action-gh-release@v2
        with:
          # è§£å†³403æ ¸å¿ƒï¼šä¼ GITHUB_TOKENï¼ˆéœ€ä»“åº“å·²å¼€è¯»å†™æƒé™ï¼‰
          token: ${{ secrets.GITHUB_TOKEN }}
          # Releaseæ ‡é¢˜ï¼šå’ŒTagåç§°ä¸€è‡´ï¼ˆå¦‚v1.0.3ï¼‰
          name: ${{ github.ref_name }}
          # Releaseæè¿°ï¼šæ¸…æ™°è¯´æ˜ç‰ˆæœ¬ã€æ¶æ„ã€ç³»ç»Ÿ
          body: "âœ… è‡ªåŠ¨æ„å»ºå‘å¸ƒï¼š${{ github.ref_name }} \nğŸ“¦ ç³»ç»Ÿ/æ¶æ„ï¼šDebian 12/Linux/amd64 \nğŸ”§ æ‰“åŒ…å·¥å…·ï¼šNuitka \nğŸ“„ ä¸»æ–‡ä»¶ï¼šapp.py"
          # è§£å†³æ–‡ä»¶åŒ¹é…å¤±è´¥ï¼šé€šé…ç¬¦åŒ¹é…æ‰€æœ‰æ‰“åŒ…äº§ç‰©
          files: ./release/*
          # æ­£å¼ç‰ˆæœ¬è®¾ä¸ºfalseï¼Œé¢„å‘å¸ƒå¯æ”¹ä¸ºtrue
          prerelease: false